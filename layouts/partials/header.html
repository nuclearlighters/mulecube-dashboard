<!-- Header - Matches main site -->
<header class="site-header">
    <nav>
	<a href="/" class="logo">
	    <img src="/images/logo_mulecube_trans_white.png" alt="MuleCube" class="logo-img logo-dark">
	    <img src="/images/logo_mulecube_trans_black.png" alt="MuleCube" class="logo-img logo-light">
	</a>        
        <button class="menu-toggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <ul class="nav-links">
            {{- range .Site.Menus.main }}
            <li>
                <a href="{{ .URL }}"{{ if .Params.external }} target="_blank" rel="noopener"{{ end }}>
                    {{ .Name }}{{ if .Params.external }} ↗{{ end }}
                </a>
            </li>
            {{- end }}
            <li>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Switch to light/dark mode"><img src="/images/icons/ui-moon.svg" alt="" class="theme-icon" id="themeIcon"></button>
            </li>
        </ul>
    </nav>
</header>

<!-- System Stats Panel -->
<div class="stats-panel">
    <div class="stats-container">
        <!-- Simple Mode (default) -->
        <div class="stats-mode stats-simple" id="statsSimple">
            <div class="stats-simple-left">
                <span class="system-health" id="systemHealth">
                    <span class="health-indicator healthy"></span>
                    <span class="health-text">All Systems Healthy</span>
                </span>
            </div>
            <div class="stats-simple-right">
                <span class="stat-item-simple" id="batterySimple" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="10" x2="23" y2="14"/><rect x="3" y="8" width="12" height="8" fill="currentColor" opacity="0.3"/></svg>
                    <span class="battery-value-simple" id="batteryValueSimple">--%</span>
                </span>
                <button class="mode-toggle-btn" id="modeToggleSimple" title="Switch to Advanced Mode">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                    Advanced
                </button>
            </div>
        </div>

        <!-- Advanced Mode -->
        <div class="stats-mode stats-advanced" id="statsAdvanced" style="display: none;">
            <span class="stat-item stat-clickable" data-tab="overview"><img src="/images/icons/stat-hostname.svg" alt="" class="stat-icon"> <span id="hostname">mulecube</span></span>
            <span class="stat-item stat-clickable" data-tab="overview"><img src="/images/icons/stat-uptime.svg" alt="" class="stat-icon"> <span id="uptime">--</span></span>
            <span class="stat-item stat-clickable" data-tab="overview"><span class="stat-label">CPU</span> <span class="stat-val" id="cpuValue">--%</span></span>
            <span class="stat-item stat-clickable" data-tab="overview"><span class="stat-label">MEM</span> <span class="stat-val" id="memValue">--%</span></span>
            <span class="stat-item stat-clickable" data-tab="storage"><span class="stat-label">DISK</span> <span class="stat-val" id="diskValue">--%</span></span>
            <span class="stat-item stat-clickable" data-tab="network"><span class="stat-label">AP</span> <span class="stat-val" id="wifiValue">--</span></span>
            <span class="stat-item stat-clickable" data-tab="network"><span class="stat-label">ETH</span> <span class="stat-val" id="ethValue">--</span></span>
            <span class="stat-item stat-clickable" data-tab="overview"><img src="/images/icons/stat-temp.svg" alt="" class="stat-icon"> <span class="stat-val" id="tempValue">--°C</span></span>
            <span class="stat-item stat-clickable" data-tab="power" id="batteryContainer" style="display: none;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="stat-icon-svg"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"/><line x1="23" y1="10" x2="23" y2="14"/><rect x="3" y="8" width="12" height="8" fill="currentColor" opacity="0.3"/></svg>
                <span class="stat-val" id="batteryValue">--%</span>
            </span>
            <button class="power-btn system-btn" id="systemBtn" title="System Management">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                System
            </button>
            <button class="power-btn reboot" id="rebootBtn" title="Reboot">↻ Reboot</button>
            <button class="power-btn shutdown" id="shutdownBtn" title="Shutdown">⏻ Shutdown</button>
            <button class="mode-toggle-btn" id="modeToggleAdvanced" title="Switch to Simple Mode">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Simple
            </button>
            <span class="stats-spacer" aria-hidden="true"></span>
        </div>
    </div>
</div>

<!-- Nominal Status Display (shown in Advanced mode header) -->
<div class="nominal-banner" id="nominalBanner" style="display: none;">
    <span class="nominal-indicator"></span>
    <span class="nominal-text">All Systems Nominal</span>
</div>

<!-- Power Control Confirmation Modal -->
<div id="powerModal" class="power-modal" style="display: none;">
    <div class="power-modal-content">
        <h3 id="powerModalTitle">Confirm Action</h3>
        <p id="powerModalMessage">Are you sure?</p>
        <div class="power-modal-buttons">
            <button id="powerModalCancel" class="modal-btn cancel-btn">Cancel</button>
            <button id="powerModalConfirm" class="modal-btn confirm-btn">Confirm</button>
        </div>
    </div>
</div>

<style>
/* Stats Panel - Aligned with site container */
.stats-panel {
    background: var(--color-bg-secondary, #111113);
    border-bottom: 1px solid var(--color-border, #27272a);
    padding: 10px 0;
    font-size: 0.8rem;
    overflow: visible;
}

.stats-container {
    max-width: var(--container-max, 1200px);
    margin: 0 auto;
    padding: 0 var(--space-lg, 1.5rem);
    overflow: visible;
}

/* Stats Mode Containers */
.stats-mode {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

/* ==========================================
   SIMPLE MODE STYLES
   ========================================== */
.stats-simple {
    min-height: 32px;
}

.stats-simple-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.stats-simple-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.system-health {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.health-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #22c55e;
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.6);
    animation: pulse-green 2s ease-in-out infinite;
}

@keyframes pulse-green {
    0%, 100% { box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
    50% { box-shadow: 0 0 16px rgba(34, 197, 94, 0.8); }
}

.health-indicator.warning {
    background: #f59e0b;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
    animation: pulse-orange 2s ease-in-out infinite;
}

@keyframes pulse-orange {
    0%, 100% { box-shadow: 0 0 8px rgba(245, 158, 11, 0.6); }
    50% { box-shadow: 0 0 16px rgba(245, 158, 11, 0.8); }
}

.health-indicator.critical {
    background: #ef4444;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    animation: pulse-red 1s ease-in-out infinite;
}

@keyframes pulse-red {
    0%, 100% { box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
    50% { box-shadow: 0 0 16px rgba(239, 68, 68, 0.8); }
}

.health-text {
    color: var(--color-text-primary, #e4e4e7);
}

.system-health.warning {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
}

.system-health.critical {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
}

.stat-item-simple {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--color-bg-tertiary, #1a1a1c);
    border: 1px solid var(--color-border, #27272a);
    border-radius: 16px;
    font-size: 0.8rem;
    color: var(--color-primary, #22c55e);
}

.stat-item-simple svg {
    flex-shrink: 0;
}

.battery-value-simple {
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    color: var(--color-primary, #22c55e);
    font-weight: 500;
}

.mode-toggle-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: transparent;
    border: 1px solid var(--color-border, #27272a);
    border-radius: 6px;
    color: var(--color-text-muted, #a1a1aa);
    font-size: 0.7rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.mode-toggle-btn:hover {
    border-color: var(--color-primary, #22c55e);
    color: var(--color-primary, #22c55e);
    background: rgba(34, 197, 94, 0.1);
}

.mode-toggle-btn svg {
    opacity: 0.7;
}

.mode-toggle-advanced {
    margin-left: 8px;
}

/* Nominal Banner (shown in advanced mode) */
.nominal-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 4px 0;
    background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
    font-size: 0.7rem;
    color: var(--color-text-muted, #a1a1aa);
}

.nominal-indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #22c55e;
}

.nominal-text {
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.nominal-banner.warning {
    background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.1), transparent);
}

.nominal-banner.warning .nominal-indicator {
    background: #f59e0b;
}

/* ==========================================
   ADVANCED MODE STYLES (existing)
   ========================================== */
.stats-advanced {
    display: flex;
    align-items: center;
    gap: 8px;
    overflow-x: auto;
    overflow-y: visible;
    padding: 4px 0;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.stats-advanced::-webkit-scrollbar {
    display: none;
}

.stats-advanced .stat-item,
.stats-advanced .power-btn,
.stats-advanced .mode-toggle-btn {
    flex-shrink: 0;
}

/* Ensure last button has space and isn't clipped */
.stats-advanced .mode-toggle-btn:last-child {
    margin-right: 1.5rem;
}

/* Spacer element to prevent button clipping */
.stats-spacer {
    display: inline-block;
    width: 2rem;
    flex-shrink: 0;
}

.stat-icon-svg {
    width: 14px;
    height: 14px;
    opacity: 0.6;
}

/* Light mode fixes for system health badge */
[data-theme="light"] .system-health {
    color: #166534;
}

[data-theme="light"] .system-health .health-text {
    color: #166534;
}

.stat-item {
    color: var(--color-text-muted, #a1a1aa);
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 0.7rem;
    background: transparent;
    border: 1px solid var(--color-border, #27272a);
    border-radius: var(--border-radius, 6px);
    padding: 4px 8px;
    height: 28px;
    box-sizing: border-box;
}

.stat-item.stat-clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}

.stat-item.stat-clickable:hover {
    border-color: var(--color-primary, #22c55e);
    background: rgba(34, 197, 94, 0.1);
}

.stat-icon {
    width: 14px;
    height: 14px;
    opacity: 0.6;
    filter: var(--icon-filter, none);
}

.stat-label {
    color: var(--color-text-muted, #a1a1aa);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.7;
}

.stat-val {
    color: var(--color-primary, #22c55e);
    font-family: var(--font-mono, 'JetBrains Mono', monospace);
    font-weight: 500;
    font-size: 0.75rem;
}

/* No separators - cleaner look */
.stats-info,
.stats-primary,
.stats-network,
.stats-hardware {
    /* Clean, no borders */
}

/* Power buttons - refined */
.power-btn {
    background: transparent;
    border: 1px solid var(--color-border, #27272a);
    border-radius: var(--border-radius, 6px);
    padding: 5px 8px;
    cursor: pointer;
    font-size: 0.65rem;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s ease;
    color: var(--color-text-muted, #a1a1aa);
    height: 28px;
    box-sizing: border-box;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
}

.power-btn:hover {
    border-color: var(--color-border-light, #3f3f46);
    color: var(--color-text, #e4e4e7);
}

.power-btn.reboot:hover {
    border-color: #3b82f6;
    color: #3b82f6;
}

.power-btn.shutdown:hover {
    border-color: #ef4444;
    color: #ef4444;
}

/* Light theme adjustments */
[data-theme="light"] .stats-panel {
    background: #f4f4f5;
    border-color: #e4e4e7;
}

[data-theme="light"] .stat-val {
    color: #16a34a;
}

[data-theme="light"] .power-btn {
    border-color: #d4d4d8;
    color: #71717a;
}

[data-theme="light"] .power-btn:hover {
    color: #3f3f46;
}

/* Responsive - hide elements progressively */
@media (max-width: 1100px) {
    .stats-info { display: none; }
}

@media (max-width: 900px) {
    .stats-container { 
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px 20px;
    }
}

@media (max-width: 768px) {
    .stats-panel { padding: 8px 0; }
    .stats-network { display: none; }
    .stats-group { gap: 12px; }
}

@media (max-width: 500px) {
    .stats-hardware { display: none; }
    .stats-container { justify-content: space-between; }
    .stat-item, .power-btn { padding: 4px 8px; font-size: 0.65rem; }
}

/* Modal styles */
.power-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.power-modal-content {
    background: var(--color-bg-card, #161618);
    border: 1px solid var(--color-border, #27272a);
    border-radius: var(--border-radius-lg, 12px);
    padding: 24px 32px;
    max-width: 380px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.power-modal-content h3 {
    margin: 0 0 12px 0;
    color: var(--color-text, #e4e4e7);
    font-size: 1.1rem;
}

.power-modal-content p {
    margin: 0 0 20px 0;
    color: var(--color-text-muted, #a1a1aa);
    font-size: 0.85rem;
    line-height: 1.5;
}

.power-modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.modal-btn {
    padding: 10px 24px;
    border-radius: var(--border-radius, 6px);
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.cancel-btn {
    background: var(--color-bg-secondary, #111113);
    border: 1px solid var(--color-border, #27272a);
    color: var(--color-text, #e4e4e7);
}

.cancel-btn:hover {
    background: var(--color-bg-card, #161618);
}

.confirm-btn {
    background: #ef4444;
    color: #fff;
}

.confirm-btn:hover {
    background: #dc2626;
}

.confirm-btn.reboot {
    background: #3b82f6;
}

.confirm-btn.reboot:hover {
    background: #2563eb;
}

/* Light theme modal */
[data-theme="light"] .power-modal-content {
    background: #fff;
    border-color: #e4e4e7;
}

[data-theme="light"] .cancel-btn {
    background: #f4f4f5;
    border-color: #e4e4e7;
    color: #3f3f46;
}
</style>

<script>
(function() {
    const rebootBtn = document.getElementById('rebootBtn');
    const shutdownBtn = document.getElementById('shutdownBtn');
    const systemBtn = document.getElementById('systemBtn');
    const modal = document.getElementById('powerModal');
    const modalTitle = document.getElementById('powerModalTitle');
    const modalMessage = document.getElementById('powerModalMessage');
    const modalCancel = document.getElementById('powerModalCancel');
    const modalConfirm = document.getElementById('powerModalConfirm');
    
    // Mode toggle elements
    const statsSimple = document.getElementById('statsSimple');
    const statsAdvanced = document.getElementById('statsAdvanced');
    const nominalBanner = document.getElementById('nominalBanner');
    const modeToggleSimple = document.getElementById('modeToggleSimple');
    const modeToggleAdvanced = document.getElementById('modeToggleAdvanced');
    
    let pendingAction = null;
    
    // Stats mode management
    function setStatsMode(mode) {
        if (mode === 'advanced') {
            if (statsSimple) statsSimple.style.display = 'none';
            if (statsAdvanced) statsAdvanced.style.display = 'flex';
            if (nominalBanner) nominalBanner.style.display = 'flex';
        } else {
            if (statsSimple) statsSimple.style.display = 'flex';
            if (statsAdvanced) statsAdvanced.style.display = 'none';
            if (nominalBanner) nominalBanner.style.display = 'none';
        }
        
        // Save preference
        if (typeof PreferencesManager !== 'undefined') {
            PreferencesManager.set('statsMode', mode);
        } else {
            localStorage.setItem('mulecube_stats_mode', mode);
        }
    }
    
    function getStatsMode() {
        if (typeof PreferencesManager !== 'undefined' && PreferencesManager.cache) {
            return PreferencesManager.get('statsMode') || 'simple';
        }
        return localStorage.getItem('mulecube_stats_mode') || 'simple';
    }
    
    // Initialize mode from saved preference
    function initStatsMode() {
        const savedMode = getStatsMode();
        setStatsMode(savedMode);
    }
    
    // Mode toggle click handlers
    if (modeToggleSimple) {
        modeToggleSimple.addEventListener('click', () => setStatsMode('advanced'));
    }
    if (modeToggleAdvanced) {
        modeToggleAdvanced.addEventListener('click', () => setStatsMode('simple'));
    }
    
    // Initialize after a brief delay to allow PreferencesManager to load
    setTimeout(initStatsMode, 100);
    
    // Power modal functions
    function showModal(action, title, message, isReboot) {
        pendingAction = action;
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalConfirm.className = 'modal-btn confirm-btn' + (isReboot ? ' reboot' : '');
        modal.style.display = 'flex';
    }
    
    function hideModal() {
        modal.style.display = 'none';
        pendingAction = null;
    }
    
    function executeAction(action) {
        window.location.href = '/reboot.html?action=' + action + '&trigger=true';
    }
    
    if (rebootBtn) {
        rebootBtn.addEventListener('click', () => {
            showModal('reboot', 'Reboot MuleCube?', 
                'System will restart in 1 minute. Services will be briefly unavailable.', true);
        });
    }
    
    if (shutdownBtn) {
        shutdownBtn.addEventListener('click', () => {
            showModal('shutdown', '⏻ Shut Down MuleCube?', 
                'System will power off in 1 minute. Physical access needed to restart!', false);
        });
    }
    
    if (systemBtn) {
        systemBtn.addEventListener('click', () => {
            if (typeof SystemManagementPanel !== 'undefined') {
                SystemManagementPanel.open();
            }
        });
    }
    
    if (modalCancel) modalCancel.addEventListener('click', hideModal);
    
    if (modalConfirm) {
        modalConfirm.addEventListener('click', () => {
            if (pendingAction) {
                executeAction(pendingAction);
            }
            hideModal();
        });
    }
    
    if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') hideModal(); });
    
    // Handle clicks on stat tiles to open System Management to the correct tab
    document.querySelectorAll('.stat-clickable').forEach(item => {
        item.addEventListener('click', () => {
            const targetTab = item.dataset.tab;
            if (targetTab && typeof SystemManagementPanel !== 'undefined') {
                SystemManagementPanel.open();
                setTimeout(() => {
                    SystemManagementPanel.loadTab(targetTab);
                }, 50);
            }
        });
    });
    
    // Also make simple mode health status clickable
    const systemHealth = document.getElementById('systemHealth');
    if (systemHealth) {
        systemHealth.style.cursor = 'pointer';
        systemHealth.addEventListener('click', () => {
            if (typeof SystemManagementPanel !== 'undefined') {
                SystemManagementPanel.open();
            }
        });
    }
})();
</script>

<style>
/* System button in stats controls */
.power-btn.system-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.power-btn.system-btn:hover {
    border-color: #22c55e;
    color: #22c55e;
}

.power-btn.system-btn svg {
    width: 14px;
    height: 14px;
}
</style>
